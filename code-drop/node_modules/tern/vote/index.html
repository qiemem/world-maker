<!doctype html>
<head>
  <meta charset="utf-8">

  <link rel=stylesheet href="doc/docs.css">
  <title>Tern: Stretch goal editor vote</title>

  <style>
    form { display: block; padding: 4px 10px; background: #f1f1f1; border-radius: 10px; }
    th { text-align: right; padding-right: .7em; font-weight: normal; font-size: inherit; }
    input { width: 20em; border: 1px solid silver; height: 1.6em; font-family: inherit; font-size: 80%; padding: 1px 5px;}
    input.button { width: auto; border-radius: 3px; background: white }
    input.button:hover { background: #eee; }
    #editorhint { position: absolute; left: 0; display: none; padding: 2px; border: 1px solid silver; background: white; border-radius: 2px; 
      max-height: 300px; overflow-y: auto; overflow-x: hidden; }
    #editorhint div { white-space: pre; overflow: hidden; max-width: 30em; padding: 0 5px; font-size: 90%; }
    #editorhint div.selected { background: #88f; color: white; border-radius: 2px; }
  </style>
</head>

<a id=head style="display: block; text-decoration: none; color: black; margin-bottom: 3em" href="/">
  <h1>Tern. <span>Intelligent JavaScript editing</span></h1>
  <img id=head-image src="doc/header.png">
</a>

<div id=main>
  <h2>Stretch goal editor vote</h2>

  <p><strong>If</strong> the 15k goal of
  the <a href="http://www.indiegogo.com/projects/tern-intelligent-javascript-editing">Tern
  crowd-funding campaign</a> is reached, I've promised to write Tern
  plug-ins for two additional editors, beyond Emacs and Vim.</p>

  <?if !$arg.voted?>

  <p>Contributors can vote on which editors these should be. If you
  contributed, enter your e-mail address (the same one that Indiegogo
  associated with your contribution) and preferred editor below.</p>

  <form method="POST">
    <table><tr>
        <th><label for=email>E-mail</label></th>
        <td><input type=text id=email name=email></td>
      </tr><tr>
        <th><label for=editor>Preferred editor</label></th>
        <td>
          <div style="display: inline-block; position: relative">
            <input type=text id=editor name=editor autocomplete=off>
            <div id=editorhint></div>
          </div>
            <input class=button type=submit value="Vote"></td>
    </tr></table>
  </form>

  <?else?>

  <p><strong>Thank you for voting.</strong> Note that the current list
  of preferred editors is not updated immediately, nor was your
  submission checked for validity right away. Check back here now and
  then if you want to see how the voting is going.</p>

  <?/if?>

  <p>Votes are weighted by the square root of your contribution
  amount. So small contributors are less influential than big ones,
  but not completly dwarfed by them.</p>

  <h2>Current scores</h2>

  <?if $arg.result ?>

  <p>The last voting result has been computed on
  <?t $arg.result.time?>. At that point, the top
  candidate<?if $arg.result.list.length > 1?>s were <?else?>
  was<?/if?>:</p>

  <ol>
    <?for $editor $arg.result.list?>
      <?if ($i < 5)?><li><?t $editor.name?> &nbsp;<span style="color: #888; font-size: 90%">(<?t $editor.score.toFixed(1)?>)</li><?/if?>
    <?/for?>
  </ol>

  <?else?>

  <p>No voting results have been computed yet.</p>

  <?/if?>

  <script>
  (function() {
    var editors = <?h JSON.stringify($arg.editors)?>;
    var editorInput = document.getElementById("editor");
    var hints = document.getElementById("editorhint");
    var selectedHint = 0;
    if (!hints || !editorInput) return;

    hints.addEventListener("click", function(e) {
      if (e.target.parentNode != hints) return;
      editorInput.value = e.target.firstChild.nodeValue;
    });
    editorInput.addEventListener("keydown", function(e) {
      if (!hints.childNodes.length) return;
      if (e.keyCode == 13) {
        e.preventDefault();
        var sel = hints.childNodes[selectedHint];
        if (sel.firstChild.nodeValue == editorInput.value) return;
        editorInput.value = sel.firstChild.nodeValue;
      } else if (e.keyCode == 27) {
        hints.innerHTML = "";
        hints.style.display = "none";
        e.preventDefault();
      } else if (e.keyCode == 38) {
        if (selectedHint) {
          hints.childNodes[selectedHint].className = "";
          hints.childNodes[--selectedHint].className = "selected";
          ensureVisible();
          e.preventDefault();
        }
      } else if (e.keyCode == 40) {
        if (selectedHint < hints.childNodes.length - 1) {
          hints.childNodes[selectedHint].className = "";
          hints.childNodes[++selectedHint].className = "selected";
          ensureVisible();
          e.preventDefault();
        }
      } else if (e.keyCode == 33) {
        if (selectedHint) {
          hints.childNodes[selectedHint].className = "";
          hints.childNodes[selectedHint = Math.max(0, selectedHint - 17)].className = "selected";
          ensureVisible();
          e.preventDefault();
        }
      } else if (e.keyCode == 34) {
        if (selectedHint < hints.childNodes.length - 1) {
          hints.childNodes[selectedHint].className = "";
          hints.childNodes[selectedHint = Math.min(hints.childNodes.length - 1, selectedHint + 17)].className = "selected";
          ensureVisible();
          e.preventDefault();
        }
      }
    });
    editorInput.addEventListener("keyup", function(e) {
      if (e.keyCode == 27 || e.keyCode == 38 || e.keyCode == 40 || e.keyCode == 33 || e.keyCode == 34) return;
      showHint();
    });
    editorInput.addEventListener("focus", function(e) {
      if (!hints.firstChild) showHint();
    });
    editorInput.addEventListener("blur", function(e) {
      hints.innerHTML = "";
      hints.style.display = "none";
    });
    function showHint() {
      var value = editorInput.value.toLowerCase();
      hints.innerHTML = "";
      hints.style.top = hints.parentNode.offsetHeight + "px";
      selectedHint = 0;
      for (var i = 0; i < editors.length; ++i) {
        var cur = editors[i];
        if (cur.toLowerCase().indexOf(value) != 0) continue;
        var elt = hints.appendChild(document.createElement("div"));
        if (elt == hints.firstChild) elt.className = "selected";
        elt.appendChild(document.createTextNode(cur));
      }
      if (hints.childNodes.length == 0 || hints.childNodes.length == 1 && hints.firstChild.firstChild.nodeValue.toLowerCase() == value) {
        hints.innerHTML = "";
        hints.style.display = "none";
      } else {
        hints.style.display = "block";
      }
    }
    function ensureVisible() {
      var box = hints.getBoundingClientRect(), opt = hints.childNodes[selectedHint].getBoundingClientRect();
      if (opt.top < box.top) hints.scrollTop -= box.top - opt.top;
      else if (opt.bottom > box.bottom) hints.scrollTop += opt.bottom - box.bottom;
    }
  })();
  </script>

</div>
