// Date, Amount, Visibility, Perk, Username, Email, Name, Address, City, State

var fs = require("fs");

var data = fs.readFileSync(process.argv[2], "utf8");
var rows = [];
var editorBlacklist = ["vim", "emacs", "sublime text 2/3"];

require("csv")().from(data).on("record", function(row, i) {
  if (i) rows.push(row);
}).on("end", function() {
  var data = fs.readFileSync(__dirname + "/transactionlog.txt", "utf8");
  var re = /(.+)\n/g, m;
  var votes = [];
  while (m = re.exec(data)) votes.push(JSON.parse(m[1]));

  var editors = {}, seen = {};

  for (var i = votes.length - 1; i >= 0; --i) {
    var vote = votes[i];
    if (seen[vote.email] || editorBlacklist.indexOf(vote.editor.toLowerCase()) >= 0) continue;
    seen[vote.email] = true;
    var contrib = getContrib(rows, vote.email);
    if (contrib > 0) {
      var low = vote.editor.toLowerCase();
      var known = editors[low] || (editors[low] = {name: vote.editor, score: 0});
      known.score += Math.sqrt(contrib);
    }
  }
  var editorList = [];
  for (var n in editors) editorList.push(editors[n]);
  editorList.sort(function(a, b) { return b.score - a.score; });
  fs.writeFileSync(__dirname + "/result.json", JSON.stringify({
    time: Date.now(),
    list: editorList
  }), "utf8");
});

function getContrib(records, email) {
  for (var i = 0, sum = 0; i < records.length; ++i) {
    var rec = records[i];
    if (rec[5] == email) sum += Number(rec[1]);
  }
  return sum;
}
