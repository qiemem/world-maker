var data = require("fs").readFileSync(process.argv[2], "utf8");
var seen = {}, list = [];

var force = {
  "ja@franz.com": "Jans Aasman",
  "david@davidflanagan.com": "David Flanagan",
  "nebyah@gmail.com": "Ben",
  "r@va.gg": "rvagg",
  "info@sachagreif.com": "Sascha Greiff",
  "simon@attentif.ch": "Simon Goumaz",
  "sh@signalwerk.ch": "Stefan Huber (Signalwerk)",
  "vollekannehoschi@gmail.com": "Stefan Gojan",
  "anton@kovalyov.net": "Anton Kovalyov",
  "i@izs.me": "Isaac Z. Schlueter",
  "dan@bravender.net": "Dan Bravender",
  "me@kasrak.com": "Kasra Kyanzadeh",
  "kuno@frob.nl": "Kuno Woudt",
  "martin@fastmail.fm": "Martin Heƒçko",
  "tom@macwright.org": "Tom MacWright",
  "indiegogo@michael.ficarra.me": "Michael Ficarra"
};

require("csv")().from(data).on("record", function(row, i) {
  if (!i || row[2] != "Visible" && row[2] != "Identity-Only") return;
  var name = force[row[5]] || row[6] || row[4], amt = Number(row[1]);
  if (/contribute\d+/.test(name)) return;
  if (/^([A-Z][a-z]+){2,}$/.test(name)) name = name.replace(/([a-z])([A-Z])/g, "$1 $2");
  var known = seen[name];
  if (known) known.amt += amt;
  else list.push(seen[name] = {name: name, amt: amt});
//  if (row[3] == "Authentic Tern laptop stickers") console.log(row[11]);
}).on("end", function() {
  list.sort(function(a, b) { return b.amt - a.amt || (a.name.toLowerCase() < b.name.toLowerCase() ? -1 : 1); });
  console.log("Backers of the donation drive that made Tern open source\nSee http://www.indiegogo.com/projects/tern-intelligent-javascript-editing\n\nSuper backers:\n");
  for (var i = 0, sawSmall = false; i < list.length; ++i) {
    var cur = list[i];
    if (!sawSmall && cur.amt < 250) { console.log("\nFurther backers:\n"); sawSmall = true; }
    console.log(cur.name);
  }
});
